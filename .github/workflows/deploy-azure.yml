name: Deploy to Azure

on:
  push:
    branches: [main, dev]
    paths:
      - "apps/worker/**"
      - "apps/api/**"
      - "packages/**"
      - ".github/workflows/deploy-azure.yml"
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  WORKER_IMAGE: neptu-worker
  API_IMAGE: neptu-api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}
    env:
      SUFFIX: ${{ github.ref_name == 'main' && '' || '-dev' }}
      TAG_ENV: ${{ github.ref_name == 'main' && 'latest' || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Create private package stubs for Docker build
        run: |
          # Wariga stub (private IP - not in repo)
          mkdir -p packages/wariga/src
          cat > packages/wariga/package.json << 'EOF'
          {"name":"@neptu/wariga","version":"0.1.0","type":"module","main":"./src/index.ts","types":"./src/index.ts","dependencies":{"@neptu/shared":"workspace:*"}}
          EOF
          cat > packages/wariga/src/index.ts << 'EOF'
          import type { Potensi, Peluang, CompatibilityResult, FullReading } from "@neptu/shared";
          export class NeptuCalculator {
            constructor(..._a: unknown[]) {}
            calculatePotensi(_d: Date): Potensi { return {} as Potensi; }
            calculatePeluang(_d: Date, _b?: Date): Peluang { return {} as Peluang; }
            calculateCompatibility(_a: Date, _b: Date): CompatibilityResult { return {} as CompatibilityResult; }
            getFullReading(_b: Date, _t?: Date): FullReading { return {} as FullReading; }
          }
          export const database: unknown = {};
          export const formatCompatibility = (..._a: unknown[]): string => "";
          export const formatFullReading = (..._a: unknown[]): string => "";
          export const formatPeluang = (..._a: unknown[]): string => "";
          export const formatPotensi = (..._a: unknown[]): string => "";
          EOF

          # CLI stub (not needed for API/Worker builds)
          mkdir -p apps/cli/src
          cat > apps/cli/package.json << 'EOF'
          {"name":"@neptu/cli","version":"0.1.0","type":"module"}
          EOF
          echo 'export {};' > apps/cli/src/index.ts

      - name: Build and push Worker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/worker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.WORKER_IMAGE }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.WORKER_IMAGE }}:${{ env.TAG_ENV }}
          cache-from: type=gha,scope=worker-${{ env.TAG_ENV }}
          cache-to: type=gha,mode=max,scope=worker-${{ env.TAG_ENV }}

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.API_IMAGE }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.API_IMAGE }}:${{ env.TAG_ENV }}
          cache-from: type=gha,scope=api-${{ env.TAG_ENV }}
          cache-to: type=gha,mode=max,scope=api-${{ env.TAG_ENV }}

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy API to Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          containerAppName: neptu-api${{ env.SUFFIX }}
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.API_IMAGE }}:${{ github.sha }}

      - name: Bind API env vars from Key Vault secrets
        run: |
          az containerapp update \
            --name neptu-api${{ env.SUFFIX }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --set-env-vars \
              "DATABASE_URL=secretref:database-url" \
              "JWT_SECRET=secretref:jwt-secret" \
              "REDIS_URL=secretref:redis-url" \
            --output none

      - name: Deploy Worker to Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          containerAppName: neptu-worker${{ env.SUFFIX }}
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.WORKER_IMAGE }}:${{ github.sha }}

      - name: Bind Worker env vars from Key Vault secrets
        run: |
          az containerapp update \
            --name neptu-worker${{ env.SUFFIX }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --set-env-vars \
              "DATABASE_URL=secretref:database-url" \
              "REDIS_URL=secretref:redis-url" \
              "AZURE_OPENAI_API_KEY=secretref:azure-openai-api-key" \
              "AZURE_OPENAI_ENDPOINT=secretref:azure-openai-endpoint" \
              "AZURE_OPENAI_DEPLOYMENT=secretref:azure-openai-deployment" \
              "COLOSSEUM_API_KEY=secretref:colosseum-api-key" \
              "COLOSSEUM_AGENT_ID=secretref:colosseum-agent-id" \
              "COLOSSEUM_AGENT_NAME=secretref:colosseum-agent-name" \
            --output none
